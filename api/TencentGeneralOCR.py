#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
    腾讯通用印刷体识别接口(高精度版)
    documents   https://cloud.tencent.com/document/product/866/34937
"""

__author__ = 'Van23qf'


import base64
import json

from tencentcloud.common import credential
from tencentcloud.common.profile.client_profile import ClientProfile
from tencentcloud.common.profile.http_profile import HttpProfile
from tencentcloud.common.exception.tencent_cloud_sdk_exception import TencentCloudSDKException
from tencentcloud.ocr.v20181119 import ocr_client, models

from api import Config

def ocr(file):
    try:
        idcardfile_base64 = str(base64.b64encode(file), 'utf-8')

        cred = credential.Credential(Config.tencent['general']['secretid'], Config.tencent['general']['secretkey'])
        httpProfile = HttpProfile()
        httpProfile.endpoint = "ocr.tencentcloudapi.com"

        clientProfile = ClientProfile('TC3-HMAC-SHA256')
        clientProfile.httpProfile = httpProfile
        client = ocr_client.OcrClient(cred, "ap-guangzhou", clientProfile)

        req = models.GeneralAccurateOCRRequest()
        params = {
            'ImageBase64': idcardfile_base64,
        }
        params_json = json.dumps(params)
        req.from_json_string(params_json)

        resp = client.GeneralAccurateOCR(req)
        resp = json.loads(resp.to_json_string())
        if not resp.get('TextDetections'):
            return {'status': False, 'msg': '识别失败'}
        data = []
        for v in resp['TextDetections']:
            data.append(v['DetectedText'])
        return {'status': True, 'msg': 'success', 'data': data}
    except FileNotFoundError as err_file:
        return {'status': False, 'msg': err_file.strerror}
    except TencentCloudSDKException as err:
        return {'status': False, 'msg': err.get_message()}


if __name__ == '__main__':
    result = ocr('../uploads/yiyuan.png')
    print(result)

"""
{'TextDetections': [{'DetectedText': '发票代码:031001600411', 'Confidence': 99, 'Polygon': [{'X': 427, 'Y': 13}, {'X': 428, 'Y': 23}, {'X': 516, 'Y': 21}, {'X': 516, 'Y': 11}], 'AdvancedInfo': '{"Parag":{"ParagNo":10}}'}, {'DetectedText': '上海增值税电子普通发票', 'Confidence': 99, 'Polygon': [{'X': 197, 'Y': 44}, {'X': 197, 'Y': 22}, {'X': 411, 'Y': 23}, {'X': 411, 'Y': 44}], 'AdvancedInfo': '{"Parag":{"ParagNo":11}}'}, {'DetectedText': '发票号码:72800806', 'Confidence': 98, 'Polygon': [{'X': 427, 'Y': 30}, {'X': 428, 'Y': 40}, {'X': 501, 'Y': 38}, {'X': 501, 'Y': 28}], 'AdvancedInfo': '{"Parag":{"ParagNo":12}}'}, {'DetectedText': 'my', 'Confidence': 51, 'Polygon': [{'X': 269, 'Y': 42}, {'X': 269, 'Y': 52}, {'X': 279, 'Y': 52}, {'X': 279, 'Y': 42}], 'AdvancedInfo': '{"Parag":{"ParagNo":13}}'}, {'DetectedText': '开票日期:2017年06月17日', 'Confidence': 99, 'Polygon': [{'X': 427, 'Y': 56}, {'X': 427, 'Y': 46}, {'X': 543, 'Y': 46}, {'X': 543, 'Y': 56}], 'AdvancedInfo': '{"Parag":{"ParagNo":14}}'}, {'DetectedText': '机器编号:061565700885', 'Confidence': 94, 'Polygon': [{'X': 30, 'Y': 65}, {'X': 30, 'Y': 74}, {'X': 123, 'Y': 71}, {'X': 123, 'Y': 62}], 'AdvancedInfo': '{"Parag":{"ParagNo":1}}'}, {'DetectedText': '校验码:71648 10975 15805 82383', 'Confidence': 83, 'Polygon': [{'X': 427, 'Y': 64}, {'X': 427, 'Y': 74}, {'X': 562, 'Y': 73}, {'X': 562, 'Y': 64}], 'AdvancedInfo': '{"Parag":{"ParagNo":15}}'}, {'DetectedText': '购', 'Confidence': 99, 'Polygon': [{'X': 28, 'Y': 91}, {'X': 28, 'Y': 101}, {'X': 38, 'Y': 101}, {'X': 38, 'Y': 91}], 'AdvancedInfo': '{"Parag":{"ParagNo":1}}'}, {'DetectedText': '名', 'Confidence': 99, 'Polygon': [{'X': 46, 'Y': 85}, {'X': 46, 'Y': 95}, {'X': 57, 'Y': 95}, {'X': 57, 'Y': 85}], 'AdvancedInfo': '{"Parag":{"ParagNo":2}}'}, {'DetectedText': '称:上海路政局', 'Confidence': 99, 'Polygon': [{'X': 90, 'Y': 85}, {'X': 90, 'Y': 95}, {'X': 151, 'Y': 94}, {'X': 151, 'Y': 85}], 'AdvancedInfo': '{"Parag":{"ParagNo":3}}'}, {'DetectedText': '密<8513/<*412084>-04263777644 ', 'Confidence': 93, 'Polygon': [{'X': 345, 'Y': 85}, {'X': 345, 'Y': 97}, {'X': 567, 'Y': 96}, {'X': 567, 'Y': 85}], 'AdvancedInfo': '{"Parag":{"ParagNo":16}}'}, {'DetectedText': '买', 'Confidence': 96, 'Polygon': [{'X': 27, 'Y': 107}, {'X': 27, 'Y': 117}, {'X': 38, 'Y': 117}, {'X': 38, 'Y': 107}], 'AdvancedInfo': '{"Parag":{"ParagNo":4}}'}, {'DetectedText': '纳税人识别号:', 'Confidence': 99, 'Polygon': [{'X': 47, 'Y': 109}, {'X': 47, 'Y': 99}, {'X': 101, 'Y': 99}, {'X': 101, 'Y': 109}], 'AdvancedInfo': '{"Parag":{"ParagNo":5}}'}, {'DetectedText': '码', 'Confidence': 99, 'Polygon': [{'X': 346, 'Y': 107}, {'X': 346, 'Y': 117}, {'X': 356, 'Y': 117}, {'X': 356, 'Y': 107}], 'AdvancedInfo': '{"Parag":{"ParagNo":16}}'}, {'DetectedText': '5>+73>>5+-04+0>4819/7813739', 'Confidence': 99, 'Polygon': [{'X': 375, 'Y': 101}, {'X': 375, 'Y': 111}, {'X': 566, 'Y': 110}, {'X': 566, 'Y': 100}], 'AdvancedInfo': '{"Parag":{"ParagNo":17}}'}, {'DetectedText': '方', 'Confidence': 97, 'Polygon': [{'X': 28, 'Y': 121}, {'X': 28, 'Y': 131}, {'X': 38, 'Y': 131}, {'X': 38, 'Y': 121}], 'AdvancedInfo': '{"Parag":{"ParagNo":6}}'}, {'DetectedText': '地址、电话:', 'Confidence': 99, 'Polygon': [{'X': 48, 'Y': 114}, {'X': 48, 'Y': 125}, {'X': 102, 'Y': 125}, {'X': 102, 'Y': 114}], 'AdvancedInfo': '{"Parag":{"ParagNo":7}}'}, {'DetectedText': '0/7+-2<+2921+>2/+43*2536761 ', 'Confidence': 96, 'Polygon': [{'X': 375, 'Y': 115}, {'X': 375, 'Y': 126}, {'X': 566, 'Y': 125}, {'X': 565, 'Y': 114}], 'AdvancedInfo': '{"Parag":{"ParagNo":17}}'}, {'DetectedText': '开户行及账号:', 'Confidence': 99, 'Polygon': [{'X': 47, 'Y': 139}, {'X': 47, 'Y': 129}, {'X': 105, 'Y': 129}, {'X': 105, 'Y': 139}], 'AdvancedInfo': '{"Parag":{"ParagNo":8}}'}, {'DetectedText': '区', 'Confidence': 99, 'Polygon': [{'X': 345, 'Y': 126}, {'X': 345, 'Y': 136}, {'X': 354, 'Y': 136}, {'X': 354, 'Y': 126}], 'AdvancedInfo': '{"Parag":{"ParagNo":18}}'}, {'DetectedText': '64402/573>>5+-04+0>4819-<>5', 'Confidence': 99, 'Polygon': [{'X': 375, 'Y': 140}, {'X': 375, 'Y': 129}, {'X': 567, 'Y': 129}, {'X': 567, 'Y': 140}], 'AdvancedInfo': '{"Parag":{"ParagNo":19}}'}, {'DetectedText': '货物或应税劳务、服务名称', 'Confidence': 99, 'Polygon': [{'X': 43, 'Y': 155}, {'X': 43, 'Y': 145}, {'X': 150, 'Y': 145}, {'X': 150, 'Y': 155}], 'AdvancedInfo': '{"Parag":{"ParagNo":9}}'}, {'DetectedText': '规格型号单位', 'Confidence': 98, 'Polygon': [{'X': 177, 'Y': 145}, {'X': 177, 'Y': 154}, {'X': 241, 'Y': 154}, {'X': 241, 'Y': 144}], 'AdvancedInfo': '{"Parag":{"ParagNo":20}}'}, {'DetectedText': '数量', 'Confidence': 98, 'Polygon': [{'X': 270, 'Y': 155}, {'X': 270, 'Y': 145}, {'X': 293, 'Y': 145}, {'X': 293, 'Y': 155}], 'AdvancedInfo': '{"Parag":{"ParagNo":21}}'}, {'DetectedText': '单价', 'Confidence': 99, 'Polygon': [{'X': 338, 'Y': 154}, {'X': 338, 'Y': 145}, {'X': 361, 'Y': 145}, {'X': 361, 'Y': 155}], 'AdvancedInfo': '{"Parag":{"ParagNo":22}}'}, {'DetectedText': '金额', 'Confidence': 99, 'Polygon': [{'X': 415, 'Y': 145}, {'X': 415, 'Y': 155}, {'X': 444, 'Y': 155}, {'X': 444, 'Y': 145}], 'AdvancedInfo': '{"Parag":{"ParagNo":23}}'}, {'DetectedText': '税率', 'Confidence': 94, 'Polygon': [{'X': 476, 'Y': 146}, {'X': 477, 'Y': 155}, {'X': 494, 'Y': 153}, {'X': 493, 'Y': 143}], 'AdvancedInfo': '{"Parag":{"ParagNo":24}}'}, {'DetectedText': '税额', 'Confidence': 98, 'Polygon': [{'X': 528, 'Y': 155}, {'X': 528, 'Y': 145}, {'X': 556, 'Y': 145}, {'X': 556, 'Y': 155}], 'AdvancedInfo': '{"Parag":{"ParagNo":25}}'}, {'DetectedText': '停车费', 'Confidence': 99, 'Polygon': [{'X': 26, 'Y': 167}, {'X': 26, 'Y': 157}, {'X': 54, 'Y': 158}, {'X': 54, 'Y': 168}], 'AdvancedInfo': '{"Parag":{"ParagNo":9}}'}, {'DetectedText': '次', 'Confidence': 99, 'Polygon': [{'X': 228, 'Y': 157}, {'X': 228, 'Y': 168}, {'X': 240, 'Y': 168}, {'X': 240, 'Y': 157}], 'AdvancedInfo': '{"Parag":{"ParagNo":26}}'}, {'DetectedText': '1', 'Confidence': 94, 'Polygon': [{'X': 309, 'Y': 156}, {'X': 309, 'Y': 169}, {'X': 316, 'Y': 169}, {'X': 316, 'Y': 156}], 'AdvancedInfo': '{"Parag":{"ParagNo":27}}'}, {'DetectedText': '660', 'Confidence': 86, 'Polygon': [{'X': 369, 'Y': 158}, {'X': 369, 'Y': 167}, {'X': 384, 'Y': 167}, {'X': 384, 'Y': 158}], 'AdvancedInfo': '{"Parag":{"ParagNo":28}}'}, {'DetectedText': '6.601 evel', 'Confidence': 71, 'Polygon': [{'X': 456, 'Y': 167}, {'X': 456, 'Y': 158}, {'X': 496, 'Y': 159}, {'X': 496, 'Y': 168}], 'AdvancedInfo': '{"Parag":{"ParagNo":29}}'}, {'DetectedText': 'Q40', 'Confidence': 91, 'Polygon': [{'X': 565, 'Y': 158}, {'X': 566, 'Y': 167}, {'X': 581, 'Y': 167}, {'X': 581, 'Y': 158}], 'AdvancedInfo': '{"Parag":{"ParagNo":30}}'}, {'DetectedText': '合', 'Confidence': 94, 'Polygon': [{'X': 59, 'Y': 253}, {'X': 59, 'Y': 263}, {'X': 69, 'Y': 263}, {'X': 69, 'Y': 253}], 'AdvancedInfo': '{"Parag":{"ParagNo":31}}'}, {'DetectedText': '计', 'Confidence': 99, 'Polygon': [{'X': 99, 'Y': 252}, {'X': 99, 'Y': 262}, {'X': 109, 'Y': 262}, {'X': 109, 'Y': 252}], 'AdvancedInfo': '{"Parag":{"ParagNo":32}}'}, {'DetectedText': '￥6.601', 'Confidence': 95, 'Polygon': [{'X': 437, 'Y': 253}, {'X': 438, 'Y': 266}, {'X': 471, 'Y': 266}, {'X': 471, 'Y': 253}], 'AdvancedInfo': '{"Parag":{"ParagNo":33}}'}, {'DetectedText': '￥0.40', 'Confidence': 99, 'Polygon': [{'X': 547, 'Y': 265}, {'X': 547, 'Y': 254}, {'X': 582, 'Y': 255}, {'X': 582, 'Y': 266}], 'AdvancedInfo': '{"Parag":{"ParagNo":34}}'}, {'DetectedText': '价税合计(大写)', 'Confidence': 99, 'Polygon': [{'X': 59, 'Y': 281}, {'X': 59, 'Y': 271}, {'X': 120, 'Y': 271}, {'X': 120, 'Y': 282}], 'AdvancedInfo': '{"Parag":{"ParagNo":35}}'}, {'DetectedText': '柒圆整', 'Confidence': 98, 'Polygon': [{'X': 174, 'Y': 281}, {'X': 174, 'Y': 270}, {'X': 214, 'Y': 271}, {'X': 214, 'Y': 282}], 'AdvancedInfo': '{"Parag":{"ParagNo":36}}'}, {'DetectedText': '(小写)￥7.00', 'Confidence': 99, 'Polygon': [{'X': 439, 'Y': 281}, {'X': 439, 'Y': 271}, {'X': 500, 'Y': 271}, {'X': 500, 'Y': 281}], 'AdvancedInfo': '{"Parag":{"ParagNo":37}}'}, {'DetectedText': '销', 'Confidence': 99, 'Polygon': [{'X': 28, 'Y': 297}, {'X': 28, 'Y': 306}, {'X': 38, 'Y': 306}, {'X': 38, 'Y': 297}], 'AdvancedInfo': '{"Parag":{"ParagNo":38}}'}, {'DetectedText': '名', 'Confidence': 99, 'Polygon': [{'X': 47, 'Y': 291}, {'X': 47, 'Y': 300}, {'X': 56, 'Y': 300}, {'X': 56, 'Y': 291}], 'AdvancedInfo': '{"Parag":{"ParagNo":39}}'}, {'DetectedText': '称上海市中智能停车股份有限公司', 'Confidence': 99, 'Polygon': [{'X': 89, 'Y': 291}, {'X': 90, 'Y': 301}, {'X': 231, 'Y': 300}, {'X': 231, 'Y': 290}], 'AdvancedInfo': '{"Parag":{"ParagNo":40}}'}, {'DetectedText': '售', 'Confidence': 99, 'Polygon': [{'X': 28, 'Y': 310}, {'X': 28, 'Y': 319}, {'X': 38, 'Y': 319}, {'X': 38, 'Y': 310}], 'AdvancedInfo': '{"Parag":{"ParagNo":41}}'}, {'DetectedText': '纳税人识别号:9131010877241 56875', 'Confidence': 96, 'Polygon': [{'X': 47, 'Y': 304}, {'X': 47, 'Y': 314}, {'X': 234, 'Y': 313}, {'X': 234, 'Y': 303}], 'AdvancedInfo': '{"Parag":{"ParagNo":42}}'}, {'DetectedText': '备', 'Confidence': 98, 'Polygon': [{'X': 345, 'Y': 297}, {'X': 345, 'Y': 307}, {'X': 354, 'Y': 307}, {'X': 354, 'Y': 297}], 'AdvancedInfo': '{"Parag":{"ParagNo":43}}'}, {'DetectedText': '备注内容:苏KX3250', 'Confidence': 99, 'Polygon': [{'X': 363, 'Y': 289}, {'X': 363, 'Y': 299}, {'X': 441, 'Y': 298}, {'X': 441, 'Y': 288}], 'AdvancedInfo': '{"Parag":{"ParagNo":44}}'}, {'DetectedText': '方', 'Confidence': 90, 'Polygon': [{'X': 28, 'Y': 324}, {'X': 28, 'Y': 333}, {'X': 38, 'Y': 333}, {'X': 38, 'Y': 324}], 'AdvancedInfo': '{"Parag":{"ParagNo":45}}'}, {'DetectedText': '地址、电话:上海市陆家浜路1130号5楼021-63451265-832', 'Confidence': 97, 'Polygon': [{'X': 47, 'Y': 318}, {'X': 47, 'Y': 328}, {'X': 272, 'Y': 327}, {'X': 272, 'Y': 317}], 'AdvancedInfo': '{"Parag":{"ParagNo":46}}'}, {'DetectedText': '中智', 'Confidence': 94, 'Polygon': [{'X': 488, 'Y': 314}, {'X': 493, 'Y': 323}, {'X': 511, 'Y': 313}, {'X': 506, 'Y': 304}], 'AdvancedInfo': '{"Parag":{"ParagNo":47}}'}, {'DetectedText': '微镜停车', 'Confidence': 56, 'Polygon': [{'X': 504, 'Y': 302}, {'X': 504, 'Y': 315}, {'X': 535, 'Y': 314}, {'X': 535, 'Y': 301}], 'AdvancedInfo': '{"Parag":{"ParagNo":47}}'}, {'DetectedText': '教份有限', 'Confidence': 93, 'Polygon': [{'X': 530, 'Y': 309}, {'X': 535, 'Y': 300}, {'X': 568, 'Y': 319}, {'X': 563, 'Y': 328}], 'AdvancedInfo': '{"Parag":{"ParagNo":47}}'}, {'DetectedText': '开户行及账号:平安银行股份有限公司上海虹口支行11005670738401', 'Confidence': 99, 'Polygon': [{'X': 47, 'Y': 341}, {'X': 47, 'Y': 330}, {'X': 305, 'Y': 331}, {'X': 305, 'Y': 342}], 'AdvancedInfo': '{"Parag":{"ParagNo":48}}'}, {'DetectedText': '注', 'Confidence': 99, 'Polygon': [{'X': 344, 'Y': 325}, {'X': 344, 'Y': 336}, {'X': 355, 'Y': 336}, {'X': 355, 'Y': 325}], 'AdvancedInfo': '{"Parag":{"ParagNo":49}}'}, {'DetectedText': '913101087724156875', 'Confidence': 99, 'Polygon': [{'X': 477, 'Y': 343}, {'X': 477, 'Y': 333}, {'X': 559, 'Y': 333}, {'X': 559, 'Y': 343}], 'AdvancedInfo': '{"Parag":{"ParagNo":50}}'}, {'DetectedText': '收款人:', 'Confidence': 97, 'Polygon': [{'X': 32, 'Y': 359}, {'X': 32, 'Y': 349}, {'X': 62, 'Y': 349}, {'X': 62, 'Y': 360}], 'AdvancedInfo': '{"Parag":{"ParagNo":51}}'}, {'DetectedText': '复核:', 'Confidence': 97, 'Polygon': [{'X': 188, 'Y': 359}, {'X': 189, 'Y': 350}, {'X': 211, 'Y': 351}, {'X': 210, 'Y': 361}], 'AdvancedInfo': '{"Parag":{"ParagNo":52}}'}, {'DetectedText': '开票人:admin', 'Confidence': 98, 'Polygon': [{'X': 308, 'Y': 359}, {'X': 308, 'Y': 349}, {'X': 365, 'Y': 350}, {'X': 365, 'Y': 361}], 'AdvancedInfo': '{"Parag":{"ParagNo":53}}'}, {'DetectedText': '销售方:(章)', 'Confidence': 99, 'Polygon': [{'X': 428, 'Y': 350}, {'X': 428, 'Y': 361}, {'X': 474, 'Y': 360}, {'X': 474, 'Y': 349}], 'AdvancedInfo': '{"Parag":{"ParagNo":54}}'}, {'DetectedText': '发票专用章', 'Confidence': 99, 'Polygon': [{'X': 500, 'Y': 348}, {'X': 500, 'Y': 361}, {'X': 550, 'Y': 361}, {'X': 549, 'Y': 348}], 'AdvancedInfo': '{"Parag":{"ParagNo":54}}'}], 'RequestId': '3b38ed58-8920-4c79-a429-afe66e15c6db'}

"""